<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acceso Secreto — Agente 007</title>
  <style>
    :root{
      --bg:#030409; --panel:#071019; --accent:#c9d6ff; --muted:#8da6cf; --green:#bdf7cb;
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#01040a 0%, #071019 100%);color:var(--accent)}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:36px}
    .card{width:min(980px,96vw);background:rgba(10,12,16,0.6);border-radius:20px;padding:28px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    .header{display:flex;align-items:center;gap:18px}
    .logo{width:92px;flex:0 0 92px}
    .logo img{width:100%;height:auto;display:block;filter:drop-shadow(0 6px 14px rgba(0,0,0,0.6))}
    .title{font-size:22px;color:#dbe9ff;letter-spacing:1px}
    .subtitle{font-size:12px;color:var(--muted);margin-top:6px}
    .grid{display:grid;grid-template-columns: 1fr 360px;gap:18px;margin-top:18px}
    .left{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    .video-wrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
    video{width:100%;height:auto;display:block;background:#000}
    .reticle{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:44%;height:60%;
      border-radius:999px;box-shadow:0 0 0 2px rgba(189,247,203,0.06) inset, 0 8px 40px rgba(0,0,0,0.6);
      pointer-events:none;border:1px dashed rgba(189,247,203,0.06)
    }
    .right{padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    .controls{display:flex;gap:10px;justify-content:center;margin-top:12px}
    button{background:#0f1720;border:1px solid rgba(255,255,255,0.03);color:var(--accent);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .status{display:flex;align-items:center;gap:10px;justify-content:center;margin-top:12px}
    .led{padding:6px 10px;border-radius:999px;font-weight:700}
    .led.off{background:#2b1a1a;color:#ffb6b6}
    .led.scan{background:#2a2430;color:#ffd8a8}
    .led.on{background:#07321a;color:#bdf7cb}
    .banner{margin-top:18px;padding:16px;border-radius:12px;text-align:center;background:linear-gradient(90deg, rgba(11,20,30,0.6), rgba(20,12,30,0.25));border:1px solid rgba(255,255,255,0.02)}
    .code{font-size:28px;font-weight:800;color:var(--green);letter-spacing:2px}
    .sub{color:var(--muted);margin-top:6px}
    .small{font-size:12px;color:var(--muted);margin-top:10px;text-align:center}
    footer{margin-top:12px;text-align:center;color:rgba(255,255,255,0.06);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="logo"><img src="https://upload.wikimedia.org/wikipedia/commons/2/2d/007_Logo.svg" alt="007 logo"></div>
        <div>
          <div class="title">Acceso Secreto — Ingreso Agentes</div>
          <div class="subtitle">Escanea tu rostro — si coincide con un perfil registrado, el sistema desplegará el código autorizado</div>
        </div>
      </div>

      <div class="grid">
        <div class="left">
          <div class="video-wrap">
            <video id="video" autoplay playsinline muted></video>
            <div class="reticle"></div>
          </div>

          <div class="controls">
            <button id="startBtn">Iniciar</button>
            <button id="stopBtn">Detener</button>
            <button id="diagBtn">/diag</button>
          </div>

          <div class="status" id="statusWrap">
            <div id="statusText">Detenido</div>
            <div id="led" class="led off">Idle</div>
          </div>

          <div class="small">Consejo: buena iluminación frontal y rostro centrado dentro de la retícula.</div>
        </div>

        <div class="right">
          <div class="banner" id="banner">
            <div id="bannerTitle" style="font-weight:700;color:#dbe9ff">Esperando escaneo…</div>
            <div id="bannerCode" class="code" style="margin-top:8px;display:none">CÓDIGO</div>
            <div id="bannerSub" class="sub">Aquí aparecerá el código de la identidad autorizada</div>
          </div>

          <div style="margin-top:12px;text-align:center">
            <div style="font-weight:700;color:#bcd3ff">Detalles</div>
            <div id="matchInfo" style="margin-top:8px;color:var(--muted)">Matches: — · Second: —</div>
          </div>
        </div>
      </div>

      <footer>Design inspired by 007 — uso educativo</footer>
    </div>
  </div>

<script>
  const video = document.getElementById('video');
  const bannerTitle = document.getElementById('bannerTitle');
  const bannerCode = document.getElementById('bannerCode');
  const bannerSub = document.getElementById('bannerSub');
  const statusText = document.getElementById('statusText');
  const led = document.getElementById('led');
  const matchInfo = document.getElementById('matchInfo');
  let timer = null;
  const canvas = document.createElement('canvas');
  canvas.width = 640; canvas.height = 480;
  const ctx = canvas.getContext('2d');

  async function startCamera(){
    try{
      const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
      video.srcObject = s;
      await video.play();
    }catch(e){
      statusText.textContent = 'Cámara no disponible';
      led.className = 'led off';
    }
  }

  function snapDataURL(){
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL('image/png');
  }

  async function doScan(){
    try{
      statusText.textContent = 'Escaneando…';
      led.className = 'led scan';
      const payload = { image: snapDataURL() };
      const r = await fetch('/scan', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if(!j.ok){
        statusText.textContent = j.error || j.msg || 'Error';
        led.className = 'led off';
        return;
      }

      // Si backend devuelve recognized:true y code -> autorizado
      if(j.recognized && j.code){
        bannerTitle.textContent = 'ACCESO AUTORIZADO';
        bannerCode.style.display = 'block';
        bannerCode.textContent = j.code;
        bannerSub.textContent = 'agente encubierto, puedes pasar al bunker con tu equipo';
        statusText.textContent = 'Autorizado';
        led.className = 'led on';
        matchInfo.textContent = `Matches: ${j.matches} · Second: ${j.second_best}`;
        clearInterval(timer); timer = null;
      }else{
        // no autorizado
        bannerTitle.textContent = 'NO AUTORIZADO';
        bannerCode.style.display = 'none';
        bannerSub.textContent = 'Rostro no reconocido entre perfiles registrados';
        statusText.textContent = 'No coincide';
        led.className = 'led off';
        matchInfo.textContent = `Matches: ${j.matches ?? 0} · Second: ${j.second_best ?? 0}`;
      }
    }catch(e){
      statusText.textContent = 'Error de red';
      led.className = 'led off';
    }
  }

  document.getElementById('startBtn').addEventListener('click', ()=>{
    if(timer) return;
    timer = setInterval(doScan, 900);
  });
  document.getElementById('stopBtn').addEventListener('click', ()=>{
    if(timer) clearInterval(timer);
    timer = null;
    statusText.textContent = 'Detenido';
    led.className = 'led off';
  });
  document.getElementById('diagBtn').addEventListener('click', ()=> window.open('/diag','_blank'));

  // inicio cámara
  startCamera();
</script>
</body>
</html>
