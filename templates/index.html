<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Face Access</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; margin:0; background:#0b0f14; color:#e6eef7; display:flex; min-height:100vh; align-items:center; justify-content:center}
    .card{width:min(920px,92vw); background:#121a23; border:1px solid #203040; border-radius:18px; padding:24px 24px 28px}
    h1{margin:0 0 10px 0; font-size:22px; color:#b9d4ff}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:18px}
    .pane{background:#0f151d; border:1px solid #1c2937; border-radius:14px; padding:14px}
    video,canvas{width:100%; border-radius:10px; background:#000}
    .status{margin-top:10px; font-size:14px; color:#91a9c4}
    .led{display:inline-block; padding:.25rem .6rem; border-radius:999px; font-weight:600; margin-left:.4rem}
    .led.red{background:#3b0d0d; color:#ffb3b3; border:1px solid #551313}
    .led.green{background:#0f3521; color:#b9ffc9; border:1px solid #165a32}
    .controls{display:flex; gap:10px; margin-top:12px}
    button{background:#1b2a3a; color:#e6eef7; border:1px solid #28455f; border-radius:10px; padding:10px 14px; cursor:pointer}
    button:hover{background:#213247}
    #codeArea{margin-top:14px; font-size:18px; font-weight:700; color:#dff7e3; display:none}
    #codeArea.show{display:block}
    .small{font-size:12px; opacity:.8}
  </style>
</head>
<body>
  <div class="card">
    <h1>Control de acceso</h1>
    <div class="row">
      <div class="pane">
        <video id="video" autoplay playsinline muted></video>
        <div class="controls">
          <button id="startBtn">Iniciar</button>
          <button id="stopBtn">Detener</button>
          <button id="diagBtn">/diag</button>
        </div>
        <div class="status">
          Estado: <span id="status">Detenido</span>
          <span id="led" class="led red">Idle</span>
        </div>
        <div id="codeArea"></div>
        <div class="small" id="matches"></div>
      </div>
      <div class="pane">
        <canvas id="canvas" width="640" height="480"></canvas>
        <div class="small">* Enviamos una captura cada ~1s a <code>/scan</code>.</div>
      </div>
    </div>
  </div>

  <script>
    const video   = document.getElementById('video');
    const canvas  = document.getElementById('canvas');
    const ctx     = canvas.getContext('2d');
    const statusE = document.getElementById('status');
    const ledE    = document.getElementById('led');
    const startB  = document.getElementById('startBtn');
    const stopB   = document.getElementById('stopBtn');
    const diagB   = document.getElementById('diagBtn');
    const codeA   = document.getElementById('codeArea');
    const matches = document.getElementById('matches');

    let timer = null;

    async function setupCam() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      video.srcObject = stream;
      await video.play();
    }

    function captureToDataURL() {
      const w = canvas.width, h = canvas.height;
      ctx.drawImage(video, 0, 0, w, h);
      return canvas.toDataURL('image/png'); // base64
    }

    async function pingScan() {
      try {
        const dataURL = captureToDataURL();
        const r = await fetch('/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: dataURL })
        });
        const j = await r.json();

        if (!j.ok) {
          statusE.textContent = j.error || j.msg || 'Error';
          ledE.textContent = 'Error';
          ledE.className = 'led red';
          return;
        }

        if (j.recognized) {
          const msg = j.message || "agente encubierto, puedes pasar al bunker con tu equipo";
          codeA.textContent = msg;          // SIEMPRE la misma frase
          codeA.classList.add('show');
          statusE.textContent = 'Match confirmado';
          ledE.textContent = 'Authorized';
          ledE.className = 'led green';
          matches.textContent = `Matches: ${j.matches}  |  Second: ${j.second_best}`;
          stopAuto();
        } else {
          statusE.textContent = 'No coincide';
          ledE.textContent = 'Scanning';
          ledE.className = 'led red';
          matches.textContent = `Matches: ${j.matches ?? 0}  |  Second: ${j.second_best ?? 0}`;
        }
      } catch (e) {
        statusE.textContent = 'Error de red';
        ledE.textContent = 'Error';
        ledE.className = 'led red';
      }
    }

    function startAuto() {
      if (timer) return;
      statusE.textContent = 'Escaneando...';
      ledE.textContent = 'Scanning';
      ledE.className = 'led red';
      timer = setInterval(pingScan, 1000);
    }

    function stopAuto() {
      if (timer) clearInterval(timer);
      timer = null;
      if (!codeA.classList.contains('show')) {
        statusE.textContent = 'Detenido';
        ledE.textContent = 'Idle';
        ledE.className = 'led red';
      }
    }

    startB.onclick = startAuto;
    stopB.onclick  = stopAuto;
    diagB.onclick  = () => window.open('/diag', '_blank');

    // Arranca cámara al cargar
    setupCam().catch(err => {
      statusE.textContent = 'Permiso de cámara denegado';
    });
  </script>
</body>
</html>
