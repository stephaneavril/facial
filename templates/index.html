<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de acceso — Agente 007</title>
  <style>
    body{margin:0;font-family:'Segoe UI',Roboto,Arial;background:#05080d;color:#e6eef7;display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden}
    .card{background:#0d1118;border:1px solid #1a2230;border-radius:18px;padding:24px;width:min(900px,92vw);box-shadow:0 0 25px rgba(0,0,0,.6)}
    h1{text-align:center;margin:0 0 20px 0;color:#c3d4f5;font-size:26px;letter-spacing:1px}
    .logo{text-align:center;margin-bottom:10px;}
    .logo img{height:70px}
    video,canvas{width:100%;border-radius:12px;background:#000}
    .controls{display:flex;gap:12px;margin-top:12px;justify-content:center}
    button{background:#1b2a3a;color:#fff;border:1px solid #2e4660;border-radius:8px;padding:10px 16px;cursor:pointer;transition:background .2s}
    button:hover{background:#213247}
    .status{text-align:center;margin-top:12px;font-size:15px;color:#9cb4d2}
    .led{display:inline-block;padding:.3rem .8rem;border-radius:999px;margin-left:.5rem;font-weight:600}
    .led.red{background:#401212;color:#ffb6b6;border:1px solid #652020}
    .led.green{background:#0f3521;color:#c1ffcb;border:1px solid #1e5d37}
    #codeArea{margin-top:18px;text-align:center;font-size:20px;font-weight:600;color:#bdf7cb;display:none}
    #codeArea.show{display:block}
    #matches{text-align:center;font-size:12px;opacity:.8;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <div class="logo"><img src="https://upload.wikimedia.org/wikipedia/commons/2/2d/007_Logo.svg" alt="Bond logo"></div>
    <h1>Acceso Secreto — Agente 007</h1>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" width="640" height="480" hidden></canvas>

    <div class="controls">
      <button id="startBtn">Iniciar escaneo</button>
      <button id="stopBtn">Detener</button>
      <button id="diagBtn">/diag</button>
    </div>

    <div class="status">
      Estado: <span id="status">Detenido</span>
      <span id="led" class="led red">Idle</span>
    </div>
    <div id="codeArea"></div>
    <div id="matches"></div>
  </div>

  <script>
    const video=document.getElementById('video'),
          canvas=document.getElementById('canvas'),
          ctx=canvas.getContext('2d'),
          statusE=document.getElementById('status'),
          ledE=document.getElementById('led'),
          codeA=document.getElementById('codeArea'),
          matches=document.getElementById('matches');
    let timer=null;

    async function setupCam(){
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
      video.srcObject=stream; await video.play();
    }
    function snap(){ctx.drawImage(video,0,0,canvas.width,canvas.height);return canvas.toDataURL('image/png');}
    async function scan(){
      try{
        const r=await fetch('/scan',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:snap()})});
        const j=await r.json();
        if(!j.ok){statusE.textContent=j.error||j.msg||'Error';return;}
        if(j.recognized){
          codeA.textContent=j.message||"agente encubierto, puedes pasar al bunker con tu equipo";
          codeA.classList.add('show');
          statusE.textContent='Match confirmado';
          ledE.textContent='Authorized'; ledE.className='led green';
          matches.textContent=`Matches: ${j.matches} | Second: ${j.second_best}`;
          clearInterval(timer); timer=null;
        }else{
          statusE.textContent='Escaneando...';
          ledE.textContent='Scanning'; ledE.className='led red';
          matches.textContent=`Matches: ${j.matches??0}`;
        }
      }catch(e){statusE.textContent='Error';}
    }
    document.getElementById('startBtn').onclick=()=>{if(!timer){timer=setInterval(scan,1000);}};
    document.getElementById('stopBtn').onclick=()=>{clearInterval(timer);timer=null;statusE.textContent='Detenido';ledE.textContent='Idle';ledE.className='led red';};
    document.getElementById('diagBtn').onclick=()=>window.open('/diag','_blank');
    setupCam().catch(()=>statusE.textContent='Permiso cámara denegado');
  </script>
</body>
</html>
